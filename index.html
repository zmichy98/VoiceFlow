<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FFT e Rilevamento Note</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    canvas {
      border: 1px solid #ddd;
      margin: 20px auto;
      display: block;
    }
    .frequency, .note {
      font-size: 1.5em;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>FFT e Rilevamento Note</h1>
  <button id="startButton">Avvia Microfono</button>
  <canvas id="fftCanvas" width="800" height="400"></canvas>
  <div class="frequency" id="frequency">Frequenza Dominante: -- Hz</div>
  <div class="note" id="note">Nota: --</div>

  <script>
    const startButton = document.getElementById('startButton');
    const frequencyDisplay = document.getElementById('frequency');
    const noteDisplay = document.getElementById('note');
    const canvas = document.getElementById('fftCanvas');
    const canvasContext = canvas.getContext('2d');

    let audioContext, analyser, microphone, dataArray, sampleRate;

    // Tabella delle note e relative frequenze
    const noteFrequencies = [
  { note: "C2", freq: 65.41 },
  { note: "C#2", freq: 69.30 },
  { note: "D2", freq: 73.42 },
  { note: "D#2", freq: 77.78 },
  { note: "E2", freq: 82.41 },
  { note: "F2", freq: 87.31 },
  { note: "F#2", freq: 92.50 },
  { note: "G2", freq: 98.00 },
  { note: "G#2", freq: 103.83 },
  { note: "A2", freq: 110.00 },
  { note: "A#2", freq: 116.54 },
  { note: "B2", freq: 123.47 },

  { note: "C3", freq: 130.81 },
  { note: "C#3", freq: 138.59 },
  { note: "D3", freq: 146.83 },
  { note: "D#3", freq: 155.56 },
  { note: "E3", freq: 164.81 },
  { note: "F3", freq: 174.61 },
  { note: "F#3", freq: 185.00 },
  { note: "G3", freq: 196.00 },
  { note: "G#3", freq: 207.65 },
  { note: "A3", freq: 220.00 },
  { note: "A#3", freq: 233.08 },
  { note: "B3", freq: 246.94 },

  { note: "C4", freq: 261.63 },
  { note: "C#4", freq: 277.18 },
  { note: "D4", freq: 293.66 },
  { note: "D#4", freq: 311.13 },
  { note: "E4", freq: 329.63 },
  { note: "F4", freq: 349.23 },
  { note: "F#4", freq: 369.99 },
  { note: "G4", freq: 392.00 },
  { note: "G#4", freq: 415.30 },
  { note: "A4", freq: 440.00 },
  { note: "A#4", freq: 466.16 },
  { note: "B4", freq: 493.88 },

  { note: "C5", freq: 523.25 },
  { note: "C#5", freq: 554.37 },
  { note: "D5", freq: 587.33 },
  { note: "D#5", freq: 622.25 },
  { note: "E5", freq: 659.25 },
  { note: "F5", freq: 698.46 },
  { note: "F#5", freq: 739.99 },
  { note: "G5", freq: 783.99 },
  { note: "G#5", freq: 830.61 },
  { note: "A5", freq: 880.00 },
  { note: "A#5", freq: 932.33 },
  { note: "B5", freq: 987.77 },

  { note: "C6", freq: 1046.50 }
];

    async function startAudio() {
      try {
        // Crea il contesto audio e ottieni il flusso dal microfono
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioContext.createMediaStreamSource(stream);

        // Configura l'analyser node
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        sampleRate = audioContext.sampleRate;
        microphone.connect(analyser);

        // Avvia l'analisi FFT
        updateFFT();
      } catch (error) {
        alert('Errore durante l\'accesso al microfono: ' + error.message);
      }
    }

    function updateFFT() {
        analyser.getByteFrequencyData(dataArray);

        // Trova la frequenza dominante
        const dominantFrequency = getDominantFrequency(dataArray, analyser.frequencyBinCount, sampleRate);

        // Cerca la fondamentale usando le armoniche
        const fundamentalFrequency = detectFundamentalFrequency(dominantFrequency, dataArray);

        // Trova la nota più vicina
        const closestNote = getClosestNote(fundamentalFrequency);

        // Mostra la frequenza fondamentale e la nota
        frequencyDisplay.textContent = `Frequenza Dominante: ${fundamentalFrequency.toFixed(2)} Hz`;
        noteDisplay.textContent = `Nota: ${closestNote.note}`;

        // Disegna il grafico FFT
        drawFFT(dataArray);

        // Aggiorna ogni 200 ms
        setTimeout(updateFFT, 400);
    }


    const noiseThreshold = 20; // Minimum enerji seviyesi

    function getDominantFrequency(dataArray, binCount, sampleRate) {
      let maxIndex = 0;
      let maxValue = -Infinity;

      for (let i = 0; i < binCount; i++) {
        if (dataArray[i] > noiseThreshold && dataArray[i] > maxValue) {
          maxValue = dataArray[i];
          maxIndex = i;
        }
      }

      // Eğer hiçbir frekans eşik değerini geçemezse, 0 dön
    if (maxValue <= noiseThreshold) return 0;

    const nyquist = sampleRate / 2;
    return (maxIndex / binCount) * nyquist;
  }


    function getClosestNote(freq) {
      if (freq <= 0) return { note: "--", freq: 0 };

      let closestNote = noteFrequencies[0];
      let minDiff = Math.abs(freq - noteFrequencies[0].freq);

      for (let i = 1; i < noteFrequencies.length; i++) {
        const diff = Math.abs(freq - noteFrequencies[i].freq);
        if (diff < minDiff) {
          minDiff = diff;
          closestNote = noteFrequencies[i];
        }
      }

      return closestNote;
    }

    function drawFFT(dataArray) {
      const barWidth = canvas.width / dataArray.length;
      const barHeightMultiplier = canvas.height / 256;

      canvasContext.clearRect(0, 0, canvas.width, canvas.height);

      dataArray.forEach((value, index) => {
        const barHeight = value * barHeightMultiplier;
        canvasContext.fillStyle = 'rgb(0, 123, 255)';
        canvasContext.fillRect(index * barWidth, canvas.height - barHeight, barWidth, barHeight);
      });
    }

    function detectFundamentalFrequency(frequency, spectrum) {
        const harmonicThreshold = 0.8; // Soglia per rilevare relazioni armoniche
        let fundamentalFrequency = frequency;

        // Cerca sottomultipli armonici (1/2, 1/3, ecc.)
        for (let harmonic = 2; harmonic <= 6; harmonic++) {
            const possibleFundamental = frequency / harmonic;
            const binIndex = Math.round((possibleFundamental / (sampleRate / 2)) * spectrum.length);

            if (binIndex > 0 && spectrum[binIndex] > harmonicThreshold * spectrum[Math.round((frequency / (sampleRate / 2)) * spectrum.length)]) {
                fundamentalFrequency = possibleFundamental;
            break;
            }   
        }

        return fundamentalFrequency;
    }


    startButton.addEventListener('click', startAudio);
  </script>
</body>
</html>


