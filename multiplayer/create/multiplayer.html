<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create an Account</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script type="module" src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/7.2.0/firebase-firestore.js"></script>
</head>
<body>
  
  <a href="../../index.html">
    <img src="logo.jpg" alt="Go to Main Page" style="position:fixed; top:15px; left:20px; width: 100px; cursor: pointer;">
  </a> 
  <div class="container">
    <h2>Create an Account</h2>
    <form id="accountForm">
      <label for="nickname">Username:</label>
      <input type="text" id="nickname" required>
      
      <label for="password">Password:</label>
      <input type="password" id="password" required>
      
      <label for="email">Email for password recovery:</label>
      <input type="email" id="email" required>

      <input type="hidden" id="level" value="beginner">
      
      <button type="submit">Create an Account</button>
    </form>
  </div>



  <!-- Include Firebase SDK via CDN -->

  <script type="module">

    const firebaseConfig = {
      apiKey: "AIzaSyB-BaTehljfDtni-HAPrYh6rKT9sJyTKaU",
      authDomain: "database-for-singing.firebaseapp.com",
      projectId: "database-for-singing",
      storageBucket: "database-for-singing.firebasestorage.app",
      messagingSenderId: "397721112623",
      appId: "1:397721112623:web:c5ec8963358f8e014736da"
    };

    firebase.initializeApp(firebaseConfig);


    firebase.firestore().settings({
    experimentalForceLongPolling: true, // Può forzare l'uso di long polling per le connessioni instabili
    persistence: false // Disabilita la modalità offline
    });

  const db = firebase.firestore();

// Funzione per hashare la password

// Gestione del form di registrazione
document.getElementById('accountForm').addEventListener('submit', async function (e) {

  try {
    // Controlla se il nickname esiste già
    const accountsRef = db.collection("store").doc("accounts");
    const docSnapshot = await accountsRef.get();

    let usersArray = [];
    
    if (docSnapshot.exists) {
      usersArray = docSnapshot.data().users || [];
      
      // Controlla se il nickname è già presente
      if (usersArray.some(user => user[0] === "test")) {
        alert('This nickname is already taken. Please choose another one.');
        return;
      }
    }

    // Creiamo l'array di dati dell'utente
    const userData = [0, 1, 2];

    // Aggiunge il nuovo utente all'array
    usersArray.push(userData);

    // Aggiorna Firestore con il nuovo array senza sovrascrivere
    await accountsRef.set({ users: usersArray }, { merge: true });

    console.log("✅ Account aggiunto correttamente!");

    alert('✅ Account successfully created!');
    window.location.href = "/multiplayer/login/login.html"; // Redirect alla pagina di login
    document.getElementById('accountForm').reset();

  } catch (error) {
    console.error('❌ Error while creating the account:', error);
    alert('An error occurred. Please try again.');
  }
});




  </script>

  

</body>
</html>

